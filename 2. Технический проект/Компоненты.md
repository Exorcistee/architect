@startuml
!include <C4/C4_Component>

title C4 - Компоненты сервиса видеоконференций (Video Conference Service)

Container(spa_client, "Веб-приложение", "React + TypeScript", "Видео интерфейс")
Container(mobile_app, "Мобильное приложение", "React Native", "Видео интерфейс")

Container(api_gateway, "API Gateway", "Nginx/Kong", "Единая точка входа")

Container(redis_cache, "Redis", "Кэш", "Хранение активных сессий")
Container(message_queue, "RabbitMQ", "Шина сообщений", "Обмен событиями")
System_Ext(turn_server, "TURN сервер", "coturn/STUN", "NAT traversal для WebRTC")
Container(storage_service, "Storage Service", "Node.js", "Хранение записей")

System_Boundary(video_service, "Video Conference Service") {
    Component(video_controller, "VideoController", "Node.js", "Обработка запросов видео")
    Component(session_manager, "SessionManager", "Node.js", "Управление видеосессиями")
    Component(webrtc_handler, "WebRTCHandler", "Node.js", "Обработка WebRTC соединений")
    Component(signaling_server, "SignalingServer", "Node.js + Socket.io", "Сигнальный сервер")
    Component(turn_server_client, "TURNServerClient", "Node.js", "Клиент для TURN сервера")
    Component(session_repository_interface, "ISessionRepository", "Интерфейс", "Абстракция доступа к данным сессий")
    Component(session_repository_impl, "SessionRepository", "Redis", "Реализация репозитория")
    Component(session_entity, "SessionEntity", "TypeScript", "Модель данных сессии")
    Component(event_publisher_interface, "IEventPublisher", "Интерфейс", "Публикация событий")
    Component(event_publisher_impl, "EventPublisher", "Node.js + RabbitMQ", "Реализация EventPublisher")
    Component(recording_service, "RecordingService", "Node.js", "Сервис записи консультаций")
}

spa_client --> api_gateway : "WebSocket соединения"
mobile_app --> api_gateway : "WebSocket соединения"

api_gateway --> video_controller : "HTTP запросы\n[REST API]"
api_gateway --> signaling_server : "WebSocket прокси"

video_controller --> session_manager : "Управление сессиями\n[Dependency Injection]"

session_manager --> webrtc_handler : "Обработка соединений\n[Dependency Injection]"
session_manager --> session_repository_interface : "Доступ к данным\nчерез интерфейс"
session_manager --> event_publisher_interface : "Публикация событий\nчерез интерфейс"
session_manager --> recording_service : "Запись консультаций\n[Dependency Injection]"

webrtc_handler --> signaling_server : "Сигнальные сообщения\n[WebSocket]"
webrtc_handler --> turn_server_client : "Получение TURN серверов\n[REST API]"

signaling_server --> webrtc_handler : "Обработка сообщений\n[WebSocket Events]"

turn_server_client --> turn_server : "Запрос TURN конфигурации\n[REST API]"

session_repository_interface <|.. session_repository_impl : "Реализация"

session_repository_impl --> session_entity : "Работа с данными"
session_entity --> redis_cache : "Хранение в Redis"

event_publisher_interface <|.. event_publisher_impl : "Реализация"
event_publisher_impl --> message_queue : "Публикация событий\n[AMQP]"

recording_service --> storage_service : "Сохранение записей\n[REST API]"

spa_client -[hidden]d-> webrtc_handler : "WebRTC поток\n[Peer-to-Peer]"
mobile_app -[hidden]d-> webrtc_handler : "WebRTC поток\n[Peer-to-Peer]"
webrtc_handler -[hidden]d-> turn_server : "TURN реле\n[UDP/TCP]"

@enduml