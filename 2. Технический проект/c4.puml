@startuml
!include <C4/C4>
!include <C4/C4_Context>
!include <C4/C4_Container>
!include <C4/C4_Component>

title C4 - Архитектура платформы онлайн-консультаций
top to bottom direction

Person(client, "Клиент", "Получает консультации, выбирает экспертов")
Person(expert, "Эксперт", "Предоставляет услуги, управляет расписанием")
Person(admin, "Администратор", "Управляет пользователями, модерирует контент")

System_Ext(payment_ext, "Платёжная система", "Stripe/CloudPayments")
System_Ext(email_ext, "Email сервис", "SendGrid/Mailgun")
System_Ext(sms_ext, "SMS сервис", "Twilio")
System_Ext(video_ext, "Видео инфраструктура", "WebRTC/TURN серверы")

System_Boundary(platform, "Платформа для онлайн-консультаций") {
    
    Container(spa_client, "Веб-приложение", "React + TypeScript", "SPA для клиентов и экспертов")
    Container(spa_admin, "Админ-панель", "React + TypeScript", "Интерфейс управления")
    Container(mobile_app, "Мобильное приложение", "React Native", "iOS/Android доступ")
    
    Container(api_gateway, "API Gateway", "Nginx/Kong", "Единая точка входа, аутентификация, балансировка")
    
    System_Boundary(core_services, "Services") {
        Container(auth_service, "Auth Service", "NestJS", "Аутентификация, авторизация, JWT")
        Container(user_service, "User Service", "NestJS", "Управление профилями, роли")
        Container(booking_service, "Booking Service", "NestJS", "Расписания, слоты, бронирования")
        Container(search_service, "Search Service", "NestJS + ElasticSearch", "Поиск и фильтрация экспертов")
        Container(payment_service, "Payment Service", "NestJS", "Платежи, транзакции, выплаты")
        Container(review_service, "Review Service", "NestJS", "Отзывы, рейтинги, репутация")
        Container(chat_service, "Chat Service", "Node.js + Socket.io", "Текстовый чат, история сообщений")
        Container(analytics_service, "Analytics Service", "NestJS", "Сбор метрик, отчеты")
        Container(notification_service, "Notifications Service", "NestJS", "Уведомления") 
    }
    
    ContainerDb(postgres_db, "Основная БД", "PostgreSQL 15", "Пользователи, бронирования, платежи")
    ContainerDb(redis_cache, "Кэш и Pub/Sub", "Redis 7", "Сессии, кэш")
    ContainerDb(message_queue, "Очередь сообщений", "RabbitMQ", "Асинхронные задачи, обработка событий")
}

Rel(client, spa_client, "Использует", "HTTPS/WebSocket")
Rel(expert, spa_client, "Работает через", "HTTPS/WebSocket")
Rel(admin, spa_admin, "Управляет через", "HTTPS")
Rel(client, mobile_app, "Мобильный доступ", "HTTPS/WebSocket")

spa_client --> api_gateway : "REST API / WebSocket"
spa_admin --> api_gateway : "REST API"
mobile_app --> api_gateway : "REST API / WebSocket"

api_gateway --> auth_service : "HTTP (логин/регистрация)"
api_gateway --> user_service : "HTTP (профили)"
api_gateway --> booking_service : "HTTP (бронирование)"
api_gateway --> search_service : "HTTP (поиск)"
api_gateway --> payment_service : "HTTP (платежи)"
api_gateway --> review_service : "HTTP (отзывы)"
api_gateway --> analytics_service : "HTTP (логирование метрик)"

api_gateway --> chat_service : "WebSocket (чат)"
api_gateway --> notification_service : "WebSocket (уведомления)"

notification_service --> email_ext : "REST API"
notification_service --> sms_ext : "REST API"

auth_service --> postgres_db : "TypeORM"
user_service --> postgres_db : "TypeORM"
booking_service --> postgres_db : "TypeORM"
payment_service --> postgres_db : "TypeORM"
review_service --> postgres_db : "TypeORM"
search_service --> postgres_db : "TypeORM"

chat_service --> redis_cache : "Pub/Sub для сообщений"
notification_service --> redis_cache : "WebSocket соединения"


analytics_service --> postgres_db : "AMQP (обработка событий)"

payment_service --> payment_ext : "REST API"


@enduml