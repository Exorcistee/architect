@startuml
!include <C4/C4>
!include <C4/C4_Context>
!include <C4/C4_Container>
!include <C4/C4_Component>

title C4 - Архитектура платформы онлайн-консультаций
top to bottom direction

Person(client, "Клиент", "Получает консультации, выбирает экспертов")
Person(expert, "Эксперт", "Предоставляет услуги, управляет расписанием")
Person(admin, "Администратор", "Управляет пользователями, модерирует контент")

System_Ext(payment_ext, "Платёжная система", "Stripe/CloudPayments")
System_Ext(email_ext, "Email сервис", "SendGrid/Mailgun")
System_Ext(sms_ext, "SMS сервис", "Twilio")
System_Ext(video_ext, "Видео инфраструктура", "WebRTC/TURN серверы")

System_Boundary(platform, "Платформа для онлайн-консультаций") {
    
    Container(spa_client, "Веб-приложение", "React + TypeScript", "SPA для клиентов и экспертов")
    Container(spa_admin, "Админ-панель", "React + TypeScript", "Интерфейс управления")
    Container(mobile_app, "Мобильное приложение", "React Native", "iOS/Android доступ")
    
    Container(api_gateway, "API Gateway", "Nginx/Kong", "Единая точка входа, аутентификация, балансировка")
    
    System_Boundary(core_services, "Бизнес-логика") {
        Component(auth_service, "Auth Service", "NestJS", "Аутентификация, авторизация, JWT")
        Component(user_service, "User Service", "NestJS", "Управление профилями, роли")
        Component(booking_service, "Booking Service", "NestJS", "Расписания, слоты, бронирования")
        Component(search_service, "Search Service", "NestJS + ElasticSearch", "Поиск и фильтрация экспертов")
        Component(payment_service, "Payment Service", "NestJS", "Платежи, транзакции, выплаты")
        Component(review_service, "Review Service", "NestJS", "Отзывы, рейтинги, репутация")
    }
    
    System_Boundary(realtime_services, "Real-time сервисы") {
        Component(session_service, "Session Service", "NestJS + Socket.io", "Управление сессиями консультаций")
        Component(webrtc_gateway, "WebRTC Gateway", "Node.js + WebRTC", "Сигналинг для видео/аудио")
        Component(chat_service, "Chat Service", "Node.js + Socket.io", "Текстовый чат, история сообщений")
        Component(notification_service, "Notification Service", "NestJS", "WebSocket/Push уведомления")
    }
    
    System_Boundary(integration_services, "Интеграционные сервисы") {
        Component(email_service, "Email Service", "NestJS", "Шаблоны, очереди email")
        Component(sms_service, "SMS Service", "NestJS", "Верификация, уведомления")
        Component(analytics_service, "Analytics Service", "NestJS", "Сбор метрик, отчеты")
    }
    
    ContainerDb(postgres_db, "Основная БД", "PostgreSQL 15", "Пользователи, бронирования, платежи")
    ContainerDb(redis_cache, "Кэш и Pub/Sub", "Redis 7", "Сессии, кэш, real-time события")
    ContainerDb(message_queue, "Очередь сообщений", "RabbitMQ", "Асинхронные задачи, обработка событий")
}

Rel(client, spa_client, "Использует", "HTTPS/WebSocket")
Rel(expert, spa_client, "Работает через", "HTTPS/WebSocket")
Rel(admin, spa_admin, "Управляет через", "HTTPS")
Rel(client, mobile_app, "Мобильный доступ", "HTTPS/WebSocket")

spa_client --> api_gateway : "REST API / WebSocket"
spa_admin --> api_gateway : "REST API"
mobile_app --> api_gateway : "REST API / WebSocket"

api_gateway --> auth_service : "HTTP (логин/регистрация)"
api_gateway --> user_service : "HTTP (профили)"
api_gateway --> booking_service : "HTTP (бронирование)"
api_gateway --> search_service : "HTTP (поиск)"
api_gateway --> payment_service : "HTTP (платежи)"
api_gateway --> review_service : "HTTP (отзывы)"
api_gateway --> analytics_service : "HTTP (логирование метрик)"

api_gateway --> session_service : "WebSocket (управление сессиями)"
api_gateway --> chat_service : "WebSocket (чат)"
api_gateway --> notification_service : "WebSocket (уведомления)"

auth_service --> user_service : "событие: пользователь создан"
booking_service --> session_service : "событие: сессия запланирована"
payment_service --> booking_service : "событие: платеж подтвержден"
review_service --> user_service : "событие: обновлен рейтинг"

session_service --> webrtc_gateway : "сигналинг (WebSocket)"
session_service --> chat_service : "инициализация чата (HTTP)"
session_service --> notification_service : "уведомление о начале (событие)"

notification_service --> email_service : "HTTP (отправка email)"
notification_service --> sms_service : "HTTP (отправка SMS)"

auth_service --> postgres_db : "TypeORM"
user_service --> postgres_db : "TypeORM"
booking_service --> postgres_db : "TypeORM"
payment_service --> postgres_db : "TypeORM"
review_service --> postgres_db : "TypeORM"
search_service --> postgres_db : "TypeORM"

session_service --> redis_cache : "хранение активных сессий"
chat_service --> redis_cache : "Pub/Sub для сообщений"
notification_service --> redis_cache : "WebSocket соединения"

email_service --> message_queue : "AMQP (отложенная отправка)"
sms_service --> message_queue : "AMQP (батчинг SMS)"
analytics_service --> postgres_db : "AMQP (обработка событий)"

webrtc_gateway --> video_ext : "WebRTC/TURN"
email_service --> email_ext : "SMTP/REST API"
sms_service --> sms_ext : "REST API"
payment_service --> payment_ext : "REST API"


@enduml